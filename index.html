<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Premium Earning App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #ff6b6b;
            --primary-gradient: linear-gradient(135deg, #ff6b6b, #ee5253);
            --secondary-color: #feca57;
            --background-light: #f5f6fa; --surface-light: #ffffff; 
            --text-primary-light: #2d3436; --text-secondary-light: #636e72; --border-light: #dcdde1;
            --background-dark: #1e272e; --surface-dark: #2f3640; 
            --text-primary-dark: #f5f6fa; --text-secondary-dark: #a4b0be; --border-dark: #4b6584;
            --success: #00b894; --danger: #d63031; --pending: #fdcb6e;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); transition: background-color 0.3s, color 0.3s; padding-top: 70px; padding-bottom: 90px; }
        
        body.light-theme { background-color: var(--background-light); color: var(--text-primary-light); }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-primary-dark); }

        #app { max-width: 500px; margin: 0 auto; position: relative; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        .premium-header {
            position: fixed; top: 0; left: 0; right: 0; height: 65px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 1000;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid;
            max-width: 500px; margin: 0 auto;
        }
        .light-theme .premium-header { background: rgba(255, 255, 255, 0.85); border-color: var(--border-light); }
        .dark-theme .premium-header { background: rgba(30, 39, 46, 0.85); border-color: var(--border-dark); }
        .user-nav-info { display: flex; align-items: center; gap: 10px; }
        #header-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .header-text { display: flex; flex-direction: column; line-height: 1.1; }
        #header-name { font-weight: 700; font-size: 0.95rem; }
        .user-rank { font-size: 0.7rem; color: var(--text-secondary-light); font-weight: 500; }
        .balance-badge { background: var(--primary-gradient); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); }

        /* CARDS & STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); border: 1px solid transparent; }
        .light-theme .stat-card { background-color: var(--surface-light); border-color: var(--border-light); }
        .dark-theme .stat-card { background-color: var(--surface-dark); border-color: var(--border-dark); }
        .stat-card h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; margin-bottom: 5px; }
        .stat-card p { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .section-title { font-size: 1.1rem; font-weight: 700; margin: 20px 0 12px; display: flex; align-items: center; gap: 8px; }
        .section-title i { color: var(--primary-color); }

        /* TASKS STYLES */
        .task-container { 
            padding: 16px; border-radius: 16px; margin-bottom: 12px; 
            display: flex; align-items: center; gap: 15px;
            box-shadow: var(--shadow); transition: transform 0.2s; position: relative;
        }
        .light-theme .task-container { background-color: var(--surface-light); border: 1px solid var(--border-light); }
        .dark-theme .task-container { background-color: var(--surface-dark); border: 1px solid var(--border-dark); }
        
        .task-icon-box { 
            width: 45px; height: 45px; border-radius: 12px; 
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; flex-shrink: 0;
        }
        .task-info { flex-grow: 1; }
        .task-info h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
        .task-info p { font-size: 0.75rem; opacity: 0.7; }
        
        .action-btn { 
            padding: 8px 16px; font-size: 0.8rem; font-weight: 600; color: #fff; 
            border: none; border-radius: 10px; cursor: pointer; 
            background: var(--primary-gradient);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
            white-space: nowrap;
        }
        .action-btn.verify-btn { background: var(--success); box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3); }
        .action-btn.check-btn { background: var(--secondary-color); color: #000; }
        .action-btn:disabled { background: #b2bec3; box-shadow: none; cursor: not-allowed; opacity: 0.7; }

        /* WALLET & REFER */
        .wallet-card { background: linear-gradient(135deg, #2c3e50, #000000); color: white; padding: 25px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .wallet-amount { font-size: 2.2rem; font-weight: 700; margin: 5px 0 15px; }
        .refer-hero { text-align: center; padding: 30px 15px; background: var(--primary-gradient); color: white; border-radius: 20px; margin-bottom: 20px; }
        .refer-link-box { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); padding: 10px; border-radius: 10px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* INPUTS & NAV */
        input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid; margin-top: 5px; font-family: inherit; font-size: 0.9rem; }
        .light-theme input, .light-theme select { background: #f1f2f6; border-color: transparent; }
        .dark-theme input, .dark-theme select { background: #3d4652; border-color: transparent; color: white; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); background: transparent; }

        .bottom-nav { position: fixed; bottom: 15px; left: 15px; right: 15px; max-width: 470px; margin: 0 auto; height: 65px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .light-theme .bottom-nav { background: #ffffff; } .dark-theme .bottom-nav { background: #2f3640; }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: #a4b0be; transition: all 0.3s; width: 20%; height: 100%; }
        .nav-btn.active { color: var(--primary-color); }
        
        /* OTHER */
        .progress-bar-bg { height: 8px; border-radius: 4px; background: rgba(0,0,0,0.1); overflow: hidden; }
        .progress-bar-fg { height: 100%; background: var(--primary-gradient); }
        .chart { display: flex; justify-content: space-around; align-items: flex-end; height: 120px; padding-top: 10px; margin-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .bar { width: 10%; background: var(--primary-gradient); border-radius: 4px 4px 0 0; opacity: 0.8; }
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(3px); }
        .popup-content { padding: 25px; border-radius: 20px; text-align: center; max-width: 85%; width: 320px; animation: popUp 0.3s; }
        .light-theme .popup-content { background: #fff; } .dark-theme .popup-content { background: #2f3640; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--background-light); }
        .dark-theme #app-loader { background: var(--background-dark); }
        .spinner { width: 40px; height: 40px; border-radius: 50%; border: 4px solid rgba(0,0,0,0.1); border-top-color: var(--primary-color); animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .history-status { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; color: white; }
        .status-completed { background-color: var(--success); } .status-pending { background-color: var(--pending); color: #000; } .status-rejected { background-color: var(--danger); }
    </style>
</head>
<body>
    
    <div id="app-loader"><div class="spinner"></div><p id="loading-progress" style="margin-top:15px; font-weight:600;">Loading...</p></div>
    <div id="popup" class="popup-overlay"><div class="popup-content"><div id="popup-body"></div><button class="action-btn" style="margin-top:15px; width:100%;" onclick="document.getElementById('popup').style.display='none'">Close</button></div></div>

    <div id="app" style="display: none;">
        <header class="premium-header">
            <div class="user-nav-info">
                <img id="header-photo" src="https://via.placeholder.com/40" alt="User">
                <div class="header-text"><span id="header-name">User</span><span class="user-rank">Member</span></div>
            </div>
            <div class="balance-badge"><i class="fas fa-coins"></i> <span id="header-balance">0.00</span></div>
        </header>

        <main id="main-content">
            <div id="home-page" class="page active">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Daily Ads</h3><p id="daily-ads-watched">0/0</p></div>
                    <div class="stat-card"><h3>Total Earned</h3><p id="total-earned">0.00</p></div>
                </div>
                <div class="stat-card" style="margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align:left;"><h3>Earning Wallet</h3><p style="font-size:1.5rem;" id="earning-wallet-balance">0.00</p></div>
                    <button id="move-to-balance-btn" class="action-btn" disabled><i class="fas fa-exchange-alt"></i> Move</button>
                </div>
                <div class="chart-container" style="padding: 15px; border-radius: 16px; background: var(--surface-light); box-shadow: var(--shadow); margin-bottom: 20px;">
                    <h3 style="font-size:0.9rem; margin-bottom:10px;">Last 7 Days Activity</h3>
                    <div id="earnings-chart" class="chart"></div><div id="earnings-chart-labels" class="chart-labels"></div>
                </div>
                <h2 class="section-title"><i class="fas fa-link"></i> Quick Links</h2>
                <div id="dynamic-links-container"></div>
            </div>

            <div id="tasks-page" class="page">
                <h2 class="section-title"><i class="fas fa-play-circle"></i> Daily Ads</h2>
                <div id="ad-progress-container" style="margin-bottom: 15px;"></div>
                <div id="ad-task-container"></div>
                
                <!-- NEW BONUS TASKS SECTION -->
                <h2 class="section-title"><i class="fas fa-gift"></i> Bonus Tasks</h2>
                <div id="dynamic-tasks-container"></div>
            </div>

            <div id="refer-page" class="page">
                <div class="refer-hero">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <h2>Invite Friends</h2>
                    <p>Earn <span id="ref-bonus-val">0</span> TK for every friend who joins!</p>
                    <div class="refer-link-box">
                        <span id="referral-link" class="refer-link-text">Loading link...</span>
                        <button id="copy-ref-link-btn" style="background:none; border:none; color:white; font-size:1.1rem;"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div class="stat-card" style="margin-bottom: 20px;"><h3>Your Total Referrals</h3><p id="referral-count">0</p></div>
                <h2 class="section-title"><i class="fas fa-trophy"></i> Top Referrers</h2>
                <div id="referral-board" style="background: var(--surface-light); border-radius: 16px; padding: 10px;">
                    <ul id="referral-leaderboard-list" style="list-style:none;"></ul>
                </div>
            </div>

            <div id="wallet-page" class="page">
                <div class="wallet-card">
                    <div class="wallet-balance-label">Available Balance</div>
                    <div class="wallet-amount"><span id="wallet-page-balance">0.00</span> TK</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Secure Withdrawals</div>
                </div>
                <h2 class="section-title"><i class="fas fa-university"></i> Withdraw Funds</h2>
                <div id="withdraw-section"></div>
                <h2 class="section-title" style="margin-top:25px;"><i class="fas fa-history"></i> History</h2>
                <div id="withdrawal-history-list" style="background: var(--surface-light); border-radius: 16px; padding: 10px; min-height: 100px;"></div>
            </div>

            <div id="profile-page" class="page">
                <div style="text-align: center; margin: 30px 0;">
                    <img id="profile-photo-large" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary-color); margin-bottom: 10px;">
                    <h2 id="profile-name-large">User Name</h2>
                    <p style="opacity: 0.7;">ID: <span id="user-id-display"></span></p>
                </div>
                <div class="task-container">
                    <div class="task-icon-box" style="background: #e1b12c; color: white;"><i class="fas fa-star"></i></div>
                    <div class="task-info"><h3>Rate Us</h3><p>Give us 5 stars</p></div>
                    <button class="action-btn">Rate</button>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="tasks-page"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-btn" data-page="refer-page"><i class="fas fa-user-plus"></i><span>Refer</span></button>
            <button class="nav-btn" data-page="wallet-page"><i class="fas fa-wallet"></i><span>Wallet</span></button>
            <button class="nav-btn" data-page="profile-page"><i class="fas fa-user"></i><span>Profile</span></button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        const firebaseConfig = {
            apiKey: "AIzaSyBLiCGAU2qQ1qa1IuzaerZYPlwsr93Hs_s",
            authDomain: "bigger-88989.firebaseapp.com",
            databaseURL: "https://bigger-88989-default-rtdb.firebaseio.com",
            projectId: "bigger-88989",
            storageBucket: "bigger-88989.firebasestorage.app",
            messagingSenderId: "288559349702",
            appId: "1:288559349702:web:9232a6bca6ec1ade4a3cc7"
        };
        
        let appConfig = {}; let userState = {}; let tgUser = {}; let earningWalletBalance = 0;
        let leaderboardData = { referral: [] }; let userTransactions = [];
        const popupBody = document.getElementById('popup-body');

        const showPopup = (content) => { popupBody.innerHTML = content; document.getElementById('popup').style.display = 'flex'; };
        const closePopup = () => { document.getElementById('popup').style.display = 'none'; };
        const updateProgress = (percentage) => { document.getElementById('loading-progress').textContent = `${percentage}%`; };

        const loadAdSdk = (zoneId) => {
            if (!zoneId || document.querySelector(`script[data-zone='${zoneId}']`)) return;
            const script = document.createElement('script'); script.src = `//libtl.com/sdk.js`;
            script.setAttribute('data-zone', zoneId); script.setAttribute('data-sdk', `show_${zoneId}`);
            script.async = true; document.body.appendChild(script);
        };

        const initApp = async () => {
            tg.ready(); tg.expand(); document.body.className = `${tg.colorScheme}-theme`;
            tgUser = tg.initDataUnsafe.user || { id: 'test_user_1', first_name: 'Test', last_name: 'User', photo_url: 'https://via.placeholder.com/80' };

            try {
                updateProgress(10); firebase.initializeApp(firebaseConfig); const db = firebase.database();
                updateProgress(30); const configSnapshot = await db.ref('config').once('value'); appConfig = configSnapshot.val() || {};
                updateProgress(50); await loadUserData(db);
                updateProgress(70);
                const [referralBoardSnap, historyPromise] = await Promise.all([
                    db.ref('users').orderByChild('referrals').limitToLast(10).once('value'),
                    loadTransactionHistory(db)
                ]);
                referralBoardSnap.forEach(child => leaderboardData.referral.push(child.val())); leaderboardData.referral.reverse();
                
                loadAdSdk(appConfig.adZoneId);
                earningWalletBalance = parseFloat(localStorage.getItem(`earningWallet_${tgUser.id}`) || '0');
                
                renderUI(); setupNavigation(); setupEventListeners();
                updateProgress(100);
                setTimeout(() => { document.getElementById('app-loader').style.display = 'none'; document.getElementById('app').style.display = 'block'; }, 500);
            } catch (error) { console.error("Init Error:", error); tg.showAlert("Network Error."); }
        };

        const loadUserData = async (db) => {
            const userRef = db.ref(`users/${tgUser.id}`); const snapshot = await userRef.once('value'); let userData = snapshot.val();
            if (!userData) {
                const startParam = tg.initDataUnsafe.start_param; const referralId = (startParam && startParam != tgUser.id) ? startParam : null;
                userData = { id: tgUser.id, firstName: tgUser.first_name || 'User', lastName: tgUser.last_name || '', photoUrl: tgUser.photo_url || '', balance: 0, referrals: 0, referredBy: referralId, totalEarned: 0, dailyAdCount: 0, lastAdWatchDate: '', completedTasks: {} };
                await userRef.set(userData);
                if (referralId) { db.ref(`users/${referralId}`).transaction(c => { if(c){c.balance=(c.balance||0)+(parseFloat(appConfig.referralBonus)||0); c.referrals=(c.referrals||0)+1;} return c; }); }
            }
            const today = new Date().toISOString().slice(0, 10);
            if (userData.lastAdWatchDate !== today) { userData.dailyAdCount = 0; userData.lastAdWatchDate = today; await userRef.update({ dailyAdCount: 0, lastAdWatchDate: today }); }
            userState = userData;
        };

        const loadTransactionHistory = async (db) => {
            userTransactions = []; const statuses = ['pending', 'completed', 'rejected'];
            const snapshots = await Promise.all(statuses.map(s => db.ref(`withdrawals/${s}`).orderByChild('userId').equalTo(tgUser.id).once('value')));
            snapshots.forEach(s => s.forEach(c => userTransactions.push(c.val()))); userTransactions.sort((a, b) => b.timestamp - a.timestamp);
        };

        const renderUI = () => {
            document.getElementById('header-photo').src = userState.photoUrl || 'https://via.placeholder.com/40';
            document.getElementById('header-name').textContent = userState.firstName;
            document.getElementById('header-balance').textContent = (userState.balance || 0).toFixed(2);
            document.getElementById('profile-photo-large').src = userState.photoUrl;
            document.getElementById('profile-name-large').textContent = userState.firstName;
            document.getElementById('user-id-display').textContent = userState.id;
            document.getElementById('daily-ads-watched').textContent = `${userState.dailyAdCount || 0}/${appConfig.dailyAdLimit || 0}`;
            document.getElementById('total-earned').textContent = (userState.totalEarned || 0).toFixed(2);
            document.getElementById('earning-wallet-balance').textContent = earningWalletBalance.toFixed(2);
            document.getElementById('wallet-page-balance').textContent = (userState.balance || 0).toFixed(2);
            document.getElementById('move-to-balance-btn').disabled = earningWalletBalance < 100;
            document.getElementById('referral-count').textContent = userState.referrals || 0;
            document.getElementById('ref-bonus-val').textContent = appConfig.referralBonus || 0;
            document.getElementById('referral-link').textContent = `https://t.me/${appConfig.botUsername}/app?startapp=${tgUser.id}`;
            renderAdTask(); renderAdProgress(); renderDynamicTasks(); renderLeaderboard(); renderWithdrawSection(); renderWithdrawalHistory(); renderEarningsGraph(); renderDynamicLinks();
        };

        // --- NEW BONUS TASKS LOGIC ---
        const renderDynamicTasks = () => {
            const container = document.getElementById('dynamic-tasks-container'); container.innerHTML = '';
            if (!appConfig.tasks) return;
            const tasks = Object.keys(appConfig.tasks).map(key => ({key, ...appConfig.tasks[key]})).reverse();

            tasks.forEach(task => {
                const isDone = userState.completedTasks && userState.completedTasks[task.key];
                let icon = '<i class="fas fa-star"></i>'; let color = '#a55eea'; let btnHtml = '';
                const type = (task.type || 'other').toLowerCase();

                // Logic for distinct buttons
                if (isDone) {
                    btnHtml = `<button class="action-btn" disabled>Completed <i class="fas fa-check-circle"></i></button>`;
                } else if (type === 'telegram') {
                    icon = '<i class="fab fa-telegram-plane"></i>'; color = '#3498db';
                    const hasStarted = localStorage.getItem(`tg_start_${task.key}`);
                    btnHtml = hasStarted 
                        ? `<button class="action-btn verify-btn" onclick="verifyTelegramTask('${task.key}')">Verify</button>` 
                        : `<button class="action-btn" onclick="startTelegramTask('${task.key}', '${task.url}')">Start</button>`;
                } else if (type === 'video') {
                    icon = '<i class="fas fa-play"></i>'; color = '#e74c3c';
                    const lockTime = localStorage.getItem(`vid_lock_${task.key}`);
                    if (lockTime && Date.now() < parseInt(lockTime)) {
                        btnHtml = `<button class="action-btn" disabled>Locked 10m</button>`;
                    } else {
                        const hasWatched = localStorage.getItem(`vid_watch_${task.key}`);
                        btnHtml = hasWatched 
                            ? `<button class="action-btn verify-btn" onclick="verifyVideoTask('${task.key}', '${task.code}')">Verify Code</button>` 
                            : `<button class="action-btn" onclick="startVideoTask('${task.key}', '${task.url}', ${task.timer||30})">Watch</button>`;
                    }
                } else if (type === 'visit') {
                    icon = '<i class="fas fa-globe"></i>'; color = '#2ecc71';
                    const visitStart = localStorage.getItem(`visit_start_${task.key}`);
                    btnHtml = visitStart 
                        ? `<button class="action-btn check-btn" onclick="checkVisitTask('${task.key}', ${task.timer||30}, '${task.url}')">Check</button>` 
                        : `<button class="action-btn" onclick="startVisitTask('${task.key}', '${task.url}')">Visit</button>`;
                } else {
                    btnHtml = `<button class="action-btn" onclick="tg.openLink('${task.url}')">Open</button>`;
                }

                const el = document.createElement('div'); el.className = 'task-container';
                el.innerHTML = `
                    <div class="task-icon-box" style="background:${color}20; color:${color};">${icon}</div>
                    <div class="task-info"><h3>${task.name}</h3><p>Reward: ${task.reward} TK</p></div>
                    ${btnHtml}
                `;
                container.appendChild(el);
            });
        };

        // --- TASK HANDLERS ---
        
        // 1. Telegram
        window.startTelegramTask = (key, url) => {
            tg.openLink(url);
            localStorage.setItem(`tg_start_${key}`, 'true');
            setTimeout(renderDynamicTasks, 1000); // Refresh to show Verify button
        };
        window.verifyTelegramTask = async (key) => {
            const task = appConfig.tasks[key];
            showPopup(`<div class="spinner"></div><p>Verifying Membership...</p>`);
            
            // NOTE: Real Bot API check requires Backend. This is a simulation/placeholder.
            // Replace this timeout with your fetch('https://your-backend.com/verify?user='+tgUser.id)
            setTimeout(async () => {
                // Simulating 80% success for demo (In real app, check API response)
                const isMember = true; 
                
                if (isMember) {
                    await completeTask(key, task.reward);
                    localStorage.removeItem(`tg_start_${key}`);
                } else {
                    closePopup(); tg.showAlert("Please join the channel first!");
                }
            }, 2000);
        };

        // 2. Video
        window.startVideoTask = (key, url, timer) => {
            tg.openLink(url);
            localStorage.setItem(`vid_watch_${key}`, 'true');
            // Store time started if you want to force them to stay away
            renderDynamicTasks();
        };
        window.verifyVideoTask = async (key, correctCode) => {
            const code = prompt("Enter the code from the video:");
            if (!code) return;
            
            if (code.trim() === correctCode) {
                const task = appConfig.tasks[key];
                await completeTask(key, task.reward);
                localStorage.removeItem(`vid_watch_${key}`);
            } else {
                tg.showAlert("Wrong code! Task locked for 10 minutes.");
                localStorage.setItem(`vid_lock_${key}`, Date.now() + (10 * 60 * 1000));
                renderDynamicTasks();
            }
        };

        // 3. Visit
        window.startVisitTask = (key, url) => {
            localStorage.setItem(`visit_start_${key}`, Date.now());
            tg.openLink(url);
            renderDynamicTasks();
        };
        window.checkVisitTask = async (key, requiredSeconds, url) => {
            const startTime = parseInt(localStorage.getItem(`visit_start_${key}`));
            const elapsed = (Date.now() - startTime) / 1000;
            
            if (elapsed >= requiredSeconds) {
                const task = appConfig.tasks[key];
                await completeTask(key, task.reward);
                localStorage.removeItem(`visit_start_${key}`);
            } else {
                const remaining = Math.ceil(requiredSeconds - elapsed);
                tg.showAlert(`You returned too early! Please stay for ${remaining} more seconds.`);
                tg.openLink(url); // Send them back
            }
        };

        const completeTask = async (key, reward) => {
            try {
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}/completedTasks/${key}`).set(true);
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(reward));
                userState.balance += reward;
                if(!userState.completedTasks) userState.completedTasks = {};
                userState.completedTasks[key] = true;
                
                tg.HapticFeedback.notificationOccurred('success');
                renderUI();
                closePopup();
                showPopup(`<h3>Task Completed!</h3><p>You received ${reward} TK.</p>`);
            } catch(e) { console.error(e); tg.showAlert("Error claiming reward."); }
        };

        // --- EXISTING LOGIC ---
        const renderAdTask = () => {
            const container = document.getElementById('ad-task-container');
            const now = Date.now();
            const onBreak = userState.breakUntil && now < userState.breakUntil;
            const limit = userState.dailyAdCount >= appConfig.dailyAdLimit;
            let btnText = "Watch"; let disabled = '';
            if (onBreak) { btnText = `Wait ${Math.ceil((userState.breakUntil - now)/60000)}m`; disabled = 'disabled'; }
            else if (limit) { btnText = "Done"; disabled = 'disabled'; }
            container.innerHTML = `<div class="task-container"><div class="task-icon-box" style="background:#f1c40f20; color:#f1c40f;"><i class="fas fa-play"></i></div><div class="task-info"><h3>Watch Ad</h3><p>Earn ${appConfig.adValue} TK</p></div><button class="action-btn" id="watch-ad-btn" ${disabled}>${btnText}</button></div>`;
            if(!onBreak && !limit) document.getElementById('watch-ad-btn').onclick = handleWatchAd;
        };

        const handleWatchAd = async () => {
            const adFn = window['show_' + appConfig.adZoneId];
            if (typeof adFn !== 'function') { tg.showAlert("Ad loading..."); return; }
            showPopup(`<div class="spinner"></div><p>Loading Ad...</p>`);
            try {
                await adFn(); closePopup();
                const val = appConfig.adValue || 0;
                earningWalletBalance += val; localStorage.setItem(`earningWallet_${tgUser.id}`, earningWalletBalance.toString());
                userState.dailyAdCount++; userState.totalEarned += val;
                const db = firebase.database();
                const updates = { dailyAdCount: userState.dailyAdCount, totalEarned: userState.totalEarned };
                if (userState.dailyAdCount % appConfig.adsPerBreak === 0 && appConfig.adsPerBreak > 0) { updates.breakUntil = Date.now() + (appConfig.breakDuration * 60000); userState.breakUntil = updates.breakUntil; }
                await db.ref(`users/${tgUser.id}`).update(updates);
                await db.ref(`userEarnings/${tgUser.id}/${new Date().toISOString().slice(0,10)}`).set(firebase.database.ServerValue.increment(val));
                renderUI(); showPopup(`<h3>Success!</h3><p>+${val} TK added to Earning Wallet.</p>`);
            } catch (e) { closePopup(); tg.showAlert("Ad failed."); }
        };

        const renderAdProgress = () => {
            const p = ((userState.dailyAdCount||0) / (appConfig.dailyAdLimit||1)) * 100;
            document.getElementById('ad-progress-container').innerHTML = `<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;"><span>Daily Progress</span><span>${userState.dailyAdCount}/${appConfig.dailyAdLimit}</span></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width:${p}%"></div></div>`;
        };
        const handleMoveToBalance = async () => {
            if(earningWalletBalance < 100) return;
            try {
                await firebase.database().ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(earningWalletBalance));
                userState.balance += earningWalletBalance; earningWalletBalance = 0;
                localStorage.setItem(`earningWallet_${tgUser.id}`, '0'); renderUI(); showPopup(`<h3>Moved!</h3><p>Funds moved to main balance.</p>`);
            } catch(e) { tg.showAlert("Error."); }
        };
        const handleWithdraw = async (e) => {
            e.preventDefault(); const min = appConfig.minimumWithdrawReferrals || 0;
            if (userState.referrals < min) { tg.showAlert(`Need ${min} referrals.`); return; }
            const amt = parseFloat(document.getElementById('amount').value);
            const method = document.getElementById('withdraw-method').value;
            const mObj = appConfig.withdrawMethods.find(m => m.name === method);
            if (amt < mObj.min || amt > userState.balance) { tg.showAlert("Invalid amount."); return; }
            document.getElementById('withdraw-submit-btn').disabled = true;
            try {
                const db = firebase.database(); const reqId = db.ref('withdrawals/pending').push().key;
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(-amt));
                await db.ref(`withdrawals/pending/${reqId}`).set({ id: reqId, userId: tgUser.id, userName: userState.firstName, method, account: document.getElementById('account-number').value, amount: amt, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });
                userState.balance -= amt; userTransactions.unshift({ method, amount: amt, status: 'pending', timestamp: Date.now() });
                renderUI(); showPopup("<h3>Requested!</h3>"); document.getElementById('withdraw-form').reset();
            } catch(e) { tg.showAlert("Failed."); } finally { document.getElementById('withdraw-submit-btn').disabled = false; }
        };
        const renderWithdrawSection = () => {
            let opts = ''; (appConfig.withdrawMethods||[]).forEach(m => opts += `<option value="${m.name}">${m.name} (Min: ${m.min})</option>`);
            document.getElementById('withdraw-section').innerHTML = `<form id="withdraw-form" style="background:var(--surface-light); padding:15px; border-radius:16px;">${(appConfig.minimumWithdrawReferrals||0)>0?`<p style="font-size:0.8rem; color:var(--danger); margin-bottom:10px;">Need ${appConfig.minimumWithdrawReferrals} refs.</p>`:''}<div style="margin-bottom:10px;"><label>Method</label><select id="withdraw-method" required>${opts}</select></div><div style="margin-bottom:10px;"><label>Account</label><input type="text" id="account-number" required></div><div style="margin-bottom:15px;"><label>Amount</label><input type="number" id="amount" required></div><button type="submit" id="withdraw-submit-btn" class="action-btn" style="width:100%;">Withdraw</button></form>`;
        };
        const renderEarningsGraph = async () => {
            const el = document.getElementById('earnings-chart'); const lbl = document.getElementById('earnings-chart-labels'); el.innerHTML=''; lbl.innerHTML='';
            const dates=[]; const today=new Date(); for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);dates.push(d.toISOString().slice(0,10));}
            const snaps = await Promise.all(dates.map(d => firebase.database().ref(`userEarnings/${tgUser.id}/${d}`).once('value')));
            const data = snaps.map(s => s.val()||0); const max = Math.max(...data,1);
            data.forEach((v,i) => { el.innerHTML+=`<div class="bar" style="height:${(v/max)*100}%"></div>`; lbl.innerHTML+=`<span>${dates[i].slice(8)}</span>`; });
        };
        const renderDynamicLinks = () => {
             const c = document.getElementById('dynamic-links-container'); c.innerHTML='';
             if(appConfig.links) Object.values(appConfig.links).forEach(l => {
                 const d = document.createElement('div'); d.className='task-container'; d.style.padding='10px';
                 d.innerHTML = `<img src="${l.icon}" style="width:30px;height:30px;border-radius:6px;margin-right:10px;"><span style="flex-grow:1;font-weight:500;font-size:0.9rem;">${l.name}</span><i class="fas fa-chevron-right" style="opacity:0.5;"></i>`;
                 d.onclick=()=>tg.openLink(l.url); c.appendChild(d);
             });
        };
        const setupNavigation = () => {
            const btns = document.querySelectorAll('.nav-btn'); const pages = document.querySelectorAll('.page');
            btns.forEach(b => b.addEventListener('click', () => {
                pages.forEach(p => p.classList.remove('active')); document.getElementById(b.dataset.page).classList.add('active');
                btns.forEach(btn => btn.classList.remove('active')); b.classList.add('active');
                if(b.dataset.page==='refer-page') renderLeaderboard();
            }));
        };
        const renderLeaderboard = () => {
            const l = document.getElementById('referral-leaderboard-list'); l.innerHTML = leaderboardData.referral.map((u, i) => `<li class="list-item"><div style="display:flex; align-items:center;"><span style="width:25px;height:25px;background:var(--secondary-color);color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:0.8rem;margin-right:10px;">${i+1}</span><img src="${u.photoUrl}" style="width:30px;height:30px;border-radius:50%;margin-right:8px;"><span style="font-weight:500;font-size:0.9rem;">${u.firstName}</span></div><span style="font-weight:700;color:var(--primary-color);">${u.referrals} Refs</span></li>`).join('');
        };
        const setupEventListeners = () => {
            document.getElementById('move-to-balance-btn').addEventListener('click', handleMoveToBalance);
            document.getElementById('withdraw-section').addEventListener('submit', handleWithdraw);
            document.getElementById('copy-ref-link-btn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('referral-link').textContent); tg.showAlert("Copied!"); });
        };

        initApp();
    });
    </script>
</body>
</html>
