<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Premium Earning App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-gradient: linear-gradient(135deg, #FF6B6B, #EE5253);
            --secondary-gradient: linear-gradient(135deg, #4834d4, #686de0);
            --gold-gradient: linear-gradient(135deg, #f1c40f, #f39c12);
            --primary-color: #EE5253; 
            --background-light: #F4F6F8; --surface-light: #FFFFFF; --text-primary-light: #2d3436; --text-secondary-light: #636e72; --border-light: #dfe6e9;
            --background-dark: #1e272e; --surface-dark: #2d3436; --text-primary-dark: #dfe6e9; --text-secondary-dark: #b2bec3; --border-dark: #4b6584;
            --success: #00b894; --danger: #d63031; --pending: #fdcb6e;
            --header-height: 70px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); transition: background-color 0.3s, color 0.3s; padding-bottom: 80px; }
        body.light-theme { background-color: var(--background-light); color: var(--text-primary-light); }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-primary-dark); }
        #app { max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; }
        
        /* --- Premium Header --- */
        .profile-header {
            height: var(--header-height);
            padding: 0 20px;
            background: var(--surface-light); /* Will be overridden by theme */
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        .light-theme .profile-header { background: rgba(255, 255, 255, 0.9); }
        .dark-theme .profile-header { background: rgba(45, 52, 54, 0.9); border-bottom: 1px solid var(--border-dark); }
        
        .user-info-mini { display: flex; align-items: center; gap: 10px; }
        #user-photo { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color); object-fit: cover; }
        .user-text h1 { font-size: 1rem; font-weight: 700; line-height: 1.2; }
        .user-text span { font-size: 0.75rem; opacity: 0.7; }
        
        .balance-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(238, 82, 83, 0.3);
            display: flex; align-items: center; gap: 5px;
        }

        /* --- Page Layout --- */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Stats --- */
        .card { padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid transparent; }
        .light-theme .card { background: var(--surface-light); border-color: var(--border-light); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .dark-theme .card { background: var(--surface-dark); border-color: var(--border-dark); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-item { padding: 15px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .light-theme .stat-item { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .dark-theme .stat-item { background: var(--surface-dark); border: 1px solid var(--border-dark); }
        .stat-item i { font-size: 1.5rem; margin-bottom: 5px; background: -webkit-linear-gradient(45deg, #FF6B6B, #EE5253); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-value { font-size: 1.2rem; font-weight: 700; margin-top: 5px; }
        .stat-label { font-size: 0.75rem; opacity: 0.7; }

        /* --- Tasks & Lists --- */
        .task-list { display: flex; flex-direction: column; gap: 15px; }
        .task-card { 
            display: flex; align-items: center; padding: 15px; border-radius: 12px; gap: 15px; position: relative; overflow: hidden;
        }
        .light-theme .task-card { background: #fff; border: 1px solid var(--border-light); }
        .dark-theme .task-card { background: var(--surface-dark); border: 1px solid var(--border-dark); }
        
        .task-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; flex-shrink: 0; }
        .icon-telegram { background: #229ED9; }
        .icon-video { background: #FF0000; }
        .icon-web { background: #10ac84; }
        
        .task-details { flex-grow: 1; }
        .task-details h4 { font-size: 1rem; font-weight: 600; margin-bottom: 3px; }
        .task-details p { font-size: 0.8rem; opacity: 0.8; }
        .task-reward { font-size: 0.85rem; font-weight: 700; color: var(--primary-color); background: rgba(238, 82, 83, 0.1); padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 4px;}

        .btn-action {
            padding: 8px 16px; border: none; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; color: white;
            background: var(--primary-gradient); transition: transform 0.2s; white-space: nowrap;
        }
        .btn-action:active { transform: scale(0.95); }
        .btn-action:disabled { background: #b2bec3; cursor: not-allowed; transform: none; }
        
        /* --- Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-light);
            display: flex; justify-content: space-around;
            padding: 10px 0 20px 0; z-index: 1000;
        }
        .dark-theme .bottom-nav { background: rgba(45, 52, 54, 0.95); border-color: var(--border-dark); }
        
        .nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; color: var(--text-secondary-light); font-size: 0.7rem; gap: 4px; cursor: pointer; flex: 1; }
        .dark-theme .nav-item { color: var(--text-secondary-dark); }
        .nav-item i { font-size: 1.4rem; transition: 0.3s; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.active i { transform: translateY(-3px); }

        /* --- Official Pages Styles --- */
        .official-header { text-align: center; padding: 20px 0; }
        .official-header i { font-size: 3rem; margin-bottom: 10px; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .official-header h2 { font-size: 1.8rem; margin-bottom: 5px; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .form-input, .form-select { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid; 
            background: transparent; color: inherit; font-family: inherit;
        }
        .light-theme .form-input { border-color: var(--border-light); } .dark-theme .form-input { border-color: var(--border-dark); }
        .form-input:focus { border-color: var(--primary-color); outline: none; }

        .btn-block { width: 100%; padding: 14px; font-size: 1rem; margin-top: 10px; }
        
        /* Copy Box */
        .copy-box { display: flex; gap: 10px; margin-top: 15px; }
        .copy-box input { flex: 1; text-align: center; border: 1px dashed var(--primary-color); background: rgba(238, 82, 83, 0.05); }

        /* Utilities */
        .hidden { display: none !important; }
        .loader-overlay { position: fixed; inset: 0; background: var(--background-light); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .dark-theme .loader-overlay { background: var(--background-dark); }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="app-loader" class="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 600;">Loading...</p>
    </div>

    <div id="app" style="display: none;">
        
        <header class="profile-header">
            <div class="user-info-mini">
                <img id="user-photo" src="https://via.placeholder.com/40" alt="User">
                <div class="user-text">
                    <h1 id="user-name">Guest</h1>
                    <span id="user-level">Beginner</span>
                </div>
            </div>
            <div class="balance-badge">
                <i class="fas fa-wallet"></i>
                <span id="header-balance">0.00</span>
            </div>
        </header>

        <main id="main-content">
            
            <div id="home-page" class="page active">
                <div class="stats-grid">
                    <div class="stat-item">
                        <i class="fas fa-eye"></i>
                        <span class="stat-value" id="daily-ads-watched">0/0</span>
                        <span class="stat-label">Daily Ads</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-coins"></i>
                        <span class="stat-value" id="total-earned">0.00</span>
                        <span class="stat-label">Total Income</span>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px; font-size: 1rem;">Analytics</h3>
                    <div id="earnings-chart" style="height: 100px; display: flex; align-items: flex-end; justify-content: space-around; gap: 5px;"></div>
                </div>

                <button class="btn-action btn-block" onclick="document.querySelector('[data-page=leaderboard-page]').click()" style="background: var(--secondary-gradient); margin-bottom: 20px;">
                    <i class="fas fa-trophy"></i> View Leaderboard
                </button>

                <div id="dynamic-links-container"></div>
            </div>

            <div id="tasks-page" class="page">
                <div class="card" style="background: var(--secondary-gradient); color: white; text-align: center;">
                    <p style="opacity: 0.9;">Earning Wallet</p>
                    <h2 style="font-size: 2.2rem; margin: 5px 0;"><span id="earning-wallet-balance">0.00</span> à§³</h2>
                    <p style="font-size: 0.8rem; margin-bottom: 15px;">Min. 100 TK to Move Main Balance</p>
                    <button id="move-to-balance-btn" class="btn-action" style="background: white; color: var(--primary-color); width: auto;" disabled>
                        Move to Balance
                    </button>
                </div>

                <h3 style="margin: 20px 0 10px; font-size: 1.1rem;">Daily Ads</h3>
                <div id="ad-task-container"></div>

                <h3 style="margin: 25px 0 10px; font-size: 1.1rem;">Bonus Tasks</h3>
                <div id="dynamic-tasks-container" class="task-list"></div>
            </div>

            <div id="wallet-page" class="page">
                <div class="official-header">
                    <i class="fas fa-university"></i>
                    <h2>Withdraw Money</h2>
                    <p>Secure & Fast Payments</p>
                </div>

                <div class="card">
                    <form id="withdraw-form">
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select id="withdraw-method" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Wallet/Account Number</label>
                            <input type="number" id="account-number" class="form-input" placeholder="017xxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount (TK)</label>
                            <input type="number" id="amount" class="form-input" placeholder="Min amount..." required>
                        </div>
                        <button type="submit" id="withdraw-submit-btn" class="btn-action btn-block">Confirm Withdraw</button>
                    </form>
                </div>
                
                <div id="withdraw-history-container" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; font-size: 1rem;">History</h3>
                    <div id="withdrawal-history-list" class="task-list"></div>
                </div>
            </div>

            <div id="refer-page" class="page">
                <div class="official-header">
                    <i class="fas fa-users"></i>
                    <h2>Invite Friends</h2>
                    <p>Earn Unlimited Rewards</p>
                </div>

                <div class="card" style="text-align: center;">
                    <img src="https://img.icons8.com/clouds/200/handshake.png" alt="Refer" style="width: 120px; margin-bottom: 10px;">
                    <h3 style="color: var(--primary-color);">Get <span id="ref-bonus-display">0</span> TK Per Refer</h3>
                    <p style="font-size: 0.9rem; margin-top: 5px; opacity: 0.8;">Share your link and earn when your friends join.</p>
                    
                    <div class="copy-box">
                        <input type="text" id="referral-link" class="form-input" readonly>
                        <button onclick="copyReferralLink()" class="btn-action" style="width: auto;"><i class="fas fa-copy"></i></button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 10px;">Your Stats</h3>
                    <div class="stats-grid" style="margin-bottom: 0;">
                        <div class="stat-item"><span class="stat-value" id="total-referrals">0</span><span class="stat-label">Total Refers</span></div>
                        <div class="stat-item"><span class="stat-value" id="referral-income">0.00</span><span class="stat-label">Ref Income</span></div>
                    </div>
                </div>
            </div>

            <div id="leaderboard-page" class="page">
                 <h2 style="margin-bottom: 15px;">Top Leaders</h2>
                 <div class="leaderboard-toggle" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-action" style="flex:1" onclick="switchBoard('referral')">Referral</button>
                    <button class="btn-action" style="flex:1; background: var(--border-dark);" onclick="switchBoard('earning')">Earning</button>
                 </div>
                 <ul id="leaderboard-list" class="task-list"></ul>
            </div>

            <div id="profile-page" class="page">
                <div class="card" style="display: flex; align-items: center; gap: 15px;">
                    <img id="profile-photo-lg" src="" style="width: 60px; height: 60px; border-radius: 50%;" alt="">
                    <div>
                        <h2 id="profile-name">Name</h2>
                        <p id="profile-id" style="opacity: 0.7; font-size: 0.8rem;">ID: 0000</p>
                    </div>
                </div>

                <div class="task-list">
                    <div class="task-card" onclick="window.Telegram.WebApp.openLink('https://t.me/YOUR_SUPPORT')">
                        <div class="task-icon" style="background: #e17055;"><i class="fas fa-headset"></i></div>
                        <div class="task-details"><h4>Support</h4><p>Contact Admin</p></div>
                        <i class="fas fa-chevron-right" style="opacity: 0.5;"></i>
                    </div>
                    </div>
            </div>

        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-item" data-page="tasks-page"><i class="fas fa-layer-group"></i><span>Tasks</span></button>
            <button class="nav-item" data-page="wallet-page"><i class="fas fa-wallet"></i><span>Wallet</span></button>
            <button class="nav-item" data-page="refer-page"><i class="fas fa-user-plus"></i><span>Refer</span></button>
            <button class="nav-item" data-page="profile-page"><i class="fas fa-user"></i><span>Profile</span></button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        // --- Firebase Config (Replace with yours) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBLiCGAU2qQ1qa1IuzaerZYPlwsr93Hs_s",
            authDomain: "bigger-88989.firebaseapp.com",
            databaseURL: "https://bigger-88989-default-rtdb.firebaseio.com",
            projectId: "bigger-88989",
            storageBucket: "bigger-88989.firebasestorage.app",
            messagingSenderId: "288559349702",
            appId: "1:288559349702:web:9232a6bca6ec1ade4a3cc7"
        };
        
        let appConfig = {}; let userState = {}; let tgUser = {}; let earningWalletBalance = 0;
        let leaderboardData = { referral: [], earning: [] };
        
        // --- Initialization ---
        const initApp = async () => {
            tg.ready(); tg.expand();
            document.body.className = `${tg.colorScheme}-theme`;
            tgUser = tg.initDataUnsafe.user;
            
            // DEV MOCK (Remove in production)
            if (!tgUser) tgUser = { id: 123456, first_name: "John", last_name: "Doe", username: "johndoe", photo_url: "" };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            
            // Load Config
            appConfig = (await db.ref('config').once('value')).val() || {};
            await loadUserData(db);
            
            // Load Leaderboard & History
            loadLeaderboard(db);
            loadWithdrawHistory(db);

            // Setup UI
            earningWalletBalance = parseFloat(localStorage.getItem(`earningWallet_${tgUser.id}`) || '0');
            renderUI();
            setupNavigation();
            setupEventListeners();
            
            // Hide Loader
            document.getElementById('app-loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Load Ads
            if (appConfig.adZoneId) loadAdSdk(appConfig.adZoneId);
        };

        const loadAdSdk = (zoneId) => {
            if (document.querySelector(`script[data-zone='${zoneId}']`)) return;
            const script = document.createElement('script');
            script.src = `//libtl.com/sdk.js`; script.dataset.zone = zoneId; script.dataset.sdk = `show_${zoneId}`;
            document.body.appendChild(script);
        };

        const loadUserData = async (db) => {
            const userRef = db.ref(`users/${tgUser.id}`);
            let snap = await userRef.once('value');
            if (!snap.exists()) {
                const startParam = tg.initDataUnsafe.start_param;
                const newUser = {
                    id: tgUser.id, firstName: tgUser.first_name, lastName: tgUser.last_name || '', 
                    balance: 0, referrals: 0, referredBy: startParam || null, totalEarned: 0,
                    dailyAdCount: 0, lastAdWatchDate: new Date().toISOString().slice(0, 10)
                };
                await userRef.set(newUser);
                // Referral Bonus Logic (Simplified)
                if (startParam && startParam != tgUser.id) {
                     db.ref(`users/${startParam}`).transaction(d => { if(d) { d.referrals = (d.referrals||0)+1; d.balance = (d.balance||0) + (appConfig.referralBonus||0); } return d; });
                }
                userState = newUser;
            } else {
                userState = snap.val();
                // Reset Daily Ad Count
                const today = new Date().toISOString().slice(0, 10);
                if (userState.lastAdWatchDate !== today) {
                    userState.dailyAdCount = 0; userState.lastAdWatchDate = today;
                    userRef.update({ dailyAdCount: 0, lastAdWatchDate: today });
                }
            }
        };

        const loadLeaderboard = async (db) => {
            const refSnap = await db.ref('users').orderByChild('referrals').limitToLast(10).once('value');
            const earnSnap = await db.ref('users').orderByChild('totalEarned').limitToLast(10).once('value');
            leaderboardData.referral = []; refSnap.forEach(c => leaderboardData.referral.unshift(c.val()));
            leaderboardData.earning = []; earnSnap.forEach(c => leaderboardData.earning.unshift(c.val()));
        };
        
        const loadWithdrawHistory = async(db) => {
            // Placeholder logic for fetching user withdrawals
            // In a real app, query 'withdrawals' node by userId
        };

        // --- Rendering UI ---
        const renderUI = () => {
            // Header
            document.getElementById('user-photo').src = userState.photoUrl || tgUser.photo_url || 'https://via.placeholder.com/40';
            document.getElementById('user-name').textContent = userState.firstName;
            document.getElementById('header-balance').textContent = (userState.balance || 0).toFixed(2);
            
            // Home Stats
            document.getElementById('daily-ads-watched').textContent = `${userState.dailyAdCount || 0}/${appConfig.dailyAdLimit || 0}`;
            document.getElementById('total-earned').textContent = (userState.totalEarned || 0).toFixed(2);
            
            // Tasks Page
            document.getElementById('earning-wallet-balance').textContent = earningWalletBalance.toFixed(2);
            document.getElementById('move-to-balance-btn').disabled = earningWalletBalance < 100;
            renderAdTask();
            renderDynamicTasks();

            // Refer Page
            document.getElementById('referral-link').value = `https://t.me/${appConfig.botUsername}/app?startapp=${tgUser.id}`;
            document.getElementById('ref-bonus-display').textContent = appConfig.referralBonus || 0;
            document.getElementById('total-referrals').textContent = userState.referrals || 0;
            
            // Wallet Page (Dropdown)
            const methodSelect = document.getElementById('withdraw-method');
            methodSelect.innerHTML = '<option value="">Select Method</option>';
            if (appConfig.withdrawMethods) {
                appConfig.withdrawMethods.forEach(m => {
                    methodSelect.innerHTML += `<option value="${m.name}">${m.name} (Min: ${m.min})</option>`;
                });
            }

            // Profile Page
            document.getElementById('profile-photo-lg').src = document.getElementById('user-photo').src;
            document.getElementById('profile-name').textContent = `${userState.firstName} ${userState.lastName}`;
            document.getElementById('profile-id').textContent = `ID: ${tgUser.id}`;
        };

        const renderAdTask = () => {
            const container = document.getElementById('ad-task-container');
            const limit = appConfig.dailyAdLimit || 10;
            if (userState.dailyAdCount >= limit) {
                container.innerHTML = `<div class="task-card"><div class="task-icon" style="background:#b2bec3"><i class="fas fa-check"></i></div><div class="task-details"><h4>Daily Limit Reached</h4><p>Come back tomorrow.</p></div></div>`;
            } else {
                container.innerHTML = `<div class="task-card"><div class="task-icon" style="background:var(--primary-gradient)"><i class="fas fa-play"></i></div><div class="task-details"><h4>Watch Ad</h4><p>Earn ${appConfig.adValue} TK</p></div><button class="btn-action" onclick="handleWatchAd()">Watch</button></div>`;
            }
        };

        // --- IMPROVED DYNAMIC TASKS (Telegram, Video, Visit) ---
        const renderDynamicTasks = () => {
            const container = document.getElementById('dynamic-tasks-container');
            container.innerHTML = '';
            
            if (!appConfig.tasks) return;

            Object.entries(appConfig.tasks).forEach(([key, task]) => {
                const isCompleted = userState.completedTasks && userState.completedTasks[key];
                
                let iconClass = 'fa-link';
                let bgClass = 'icon-web';
                let btnText = isCompleted ? 'Claimed' : 'Start';
                
                // Determine Type Styling
                if (task.type === 'telegram') { iconClass = 'fa-paper-plane'; bgClass = 'icon-telegram'; btnText = isCompleted ? 'Joined' : 'Join'; }
                else if (task.type === 'video') { iconClass = 'fa-youtube'; bgClass = 'icon-video'; btnText = isCompleted ? 'Watched' : 'Watch'; }
                
                const div = document.createElement('div');
                div.className = 'task-card';
                div.innerHTML = `
                    <div class="task-icon ${bgClass}"><i class="fab ${iconClass}"></i></div>
                    <div class="task-details">
                        <h4>${task.name}</h4>
                        <div class="task-reward">+${task.reward} TK</div>
                    </div>
                    <button class="btn-action" 
                        data-id="${key}" 
                        data-type="${task.type}" 
                        data-url="${task.url}" 
                        data-timer="${task.timer || 10}"
                        ${isCompleted ? 'disabled' : ''}>
                        ${btnText}
                    </button>
                `;
                container.appendChild(div);
            });
        };

        // --- LOGIC: Handle Task Clicks ---
        window.handleTaskClick = async (btn) => {
            const { id, type, url, timer } = btn.dataset;
            
            if (type === 'telegram' || type === 'visit') {
                tg.openLink(url);
                // Simple logic: Change button to "Claim" after returning? 
                // Or wait 5 seconds then allow claim
                btn.textContent = "Checking...";
                btn.disabled = true;
                setTimeout(() => {
                    btn.textContent = "Claim Reward";
                    btn.disabled = false;
                    btn.onclick = () => claimReward(id, btn);
                }, 5000); // 5 sec delay to simulate check
            } 
            else if (type === 'video') {
                tg.openLink(url);
                let timeLeft = parseInt(timer);
                btn.disabled = true;
                
                const interval = setInterval(() => {
                    btn.textContent = `Wait ${timeLeft}s`;
                    timeLeft--;
                    if (timeLeft < 0) {
                        clearInterval(interval);
                        btn.textContent = "Claim Reward";
                        btn.disabled = false;
                        btn.onclick = () => claimReward(id, btn);
                    }
                }, 1000);
            }
        };

        const claimReward = async (taskId, btn) => {
            btn.textContent = "Claiming..."; btn.disabled = true;
            try {
                const reward = appConfig.tasks[taskId].reward;
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(reward));
                await db.ref(`users/${tgUser.id}/completedTasks/${taskId}`).set(true);
                
                userState.balance += reward;
                if(!userState.completedTasks) userState.completedTasks = {};
                userState.completedTasks[taskId] = true;
                
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Success! Added ${reward} TK.`);
                renderUI();
            } catch(e) {
                console.error(e);
                btn.textContent = "Error";
            }
        };

        // --- Global Handlers ---
        window.handleWatchAd = async () => {
            const adFn = window['show_' + appConfig.adZoneId];
            if (!adFn) { tg.showAlert("Ad loading..."); return; }
            try {
                await adFn();
                // Success logic
                earningWalletBalance += (appConfig.adValue || 0);
                localStorage.setItem(`earningWallet_${tgUser.id}`, earningWalletBalance);
                
                userState.dailyAdCount++;
                userState.totalEarned += (appConfig.adValue || 0);
                
                firebase.database().ref(`users/${tgUser.id}`).update({
                    dailyAdCount: userState.dailyAdCount,
                    totalEarned: userState.totalEarned
                });
                
                renderUI();
                tg.HapticFeedback.notificationOccurred('success');
            } catch(e) { tg.showAlert("Ad failed to load"); }
        };

        window.copyReferralLink = () => {
            const copyText = document.getElementById("referral-link");
            copyText.select();
            document.execCommand("copy");
            tg.showAlert("Link Copied!");
        };
        
        // --- Navigation Setup ---
        const setupNavigation = () => {
            const buttons = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Visual Update
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Page Update
                    const targetId = btn.dataset.page;
                    pages.forEach(p => p.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');
                    window.scrollTo(0,0);
                });
            });

            // Delegate Task Clicks
            document.getElementById('dynamic-tasks-container').addEventListener('click', (e) => {
                if(e.target.classList.contains('btn-action')) window.handleTaskClick(e.target);
            });
            
            // Move Balance
            document.getElementById('move-to-balance-btn').addEventListener('click', async () => {
                if(earningWalletBalance < 100) return;
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(earningWalletBalance));
                userState.balance += earningWalletBalance;
                earningWalletBalance = 0;
                localStorage.setItem(`earningWallet_${tgUser.id}`, 0);
                tg.showAlert("Balance Moved!");
                renderUI();
            });
        };

        // Init
        initApp();
    });
    </script>
</body>
</html>
