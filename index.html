<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Premium Earning App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        /* --- CORE VARIABLES & THEME --- */
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #ff6b6b; 
            --primary-gradient: linear-gradient(135deg, #ff6b6b, #ee5253);
            --secondary-color: #feca57;
            --background-light: #f5f6fa; --surface-light: #ffffff; 
            --text-primary-light: #2d3436; --text-secondary-light: #636e72; --border-light: #dcdde1;
            --background-dark: #1e272e; --surface-dark: #2f3640; 
            --text-primary-dark: #f5f6fa; --text-secondary-dark: #a4b0be; --border-dark: #4b6584;
            --success: #00b894; --danger: #d63031; --pending: #fdcb6e;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); transition: background-color 0.3s, color 0.3s; padding-top: 70px; padding-bottom: 90px; }
        
        body.light-theme { background-color: var(--background-light); color: var(--text-primary-light); }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-primary-dark); }

        #app { max-width: 500px; margin: 0 auto; position: relative; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PREMIUM HEADER (SMALL) --- */
        .premium-header {
            position: fixed; top: 0; left: 0; right: 0; height: 65px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 1000;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid; max-width: 500px; margin: 0 auto;
        }
        .light-theme .premium-header { background: rgba(255, 255, 255, 0.85); border-color: var(--border-light); }
        .dark-theme .premium-header { background: rgba(30, 39, 46, 0.85); border-color: var(--border-dark); }

        .user-nav-info { display: flex; align-items: center; gap: 10px; }
        #header-photo { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .header-text { display: flex; flex-direction: column; line-height: 1.1; }
        #header-name { font-weight: 700; font-size: 0.9rem; }
        .user-rank { font-size: 0.65rem; color: var(--text-secondary-light); font-weight: 500; }
        
        .balance-badge {
            background: var(--primary-gradient); color: white;
            padding: 5px 12px; border-radius: 20px;
            font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        /* --- CARDS & STATS --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); border: 1px solid transparent; }
        .light-theme .stat-card { background-color: var(--surface-light); border-color: var(--border-light); }
        .dark-theme .stat-card { background-color: var(--surface-dark); border-color: var(--border-dark); }
        
        .stat-card h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; margin-bottom: 5px; }
        .stat-card p { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .section-title { font-size: 1.1rem; font-weight: 700; margin: 20px 0 12px; display: flex; align-items: center; gap: 8px; }

        /* --- NEW TASK DESIGN --- */
        .task-container { 
            padding: 12px 15px; border-radius: 16px; margin-bottom: 12px; 
            display: flex; align-items: center; gap: 12px;
            box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .light-theme .task-container { background-color: var(--surface-light); border: 1px solid var(--border-light); }
        .dark-theme .task-container { background-color: var(--surface-dark); border: 1px solid var(--border-dark); }
        
        .task-icon-box { 
            width: 42px; height: 42px; border-radius: 10px; 
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; flex-shrink: 0;
        }
        
        .task-info { flex-grow: 1; }
        .task-info h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 3px; }
        .task-info p { font-size: 0.75rem; font-weight: 500; color: var(--success); }
        
        /* Button Styles */
        .action-btn { 
            padding: 8px 18px; font-size: 0.75rem; font-weight: 600; color: #fff; 
            border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;
            background: var(--primary-gradient);
            box-shadow: 0 3px 8px rgba(255, 107, 107, 0.3); transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.95); }
        .btn-start { background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3); }
        .btn-verify { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000; box-shadow: 0 3px 8px rgba(241, 196, 15, 0.3); }
        .btn-done { background: #27ae60; cursor: default; box-shadow: none; opacity: 0.7; }
        .btn-lock { background: #e74c3c; cursor: not-allowed; opacity: 0.8; }

        /* --- WALLET & REFER --- */
        .wallet-card {
            background: linear-gradient(135deg, #2c3e50, #000000);
            color: white; padding: 25px; border-radius: 20px;
            margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        .refer-hero {
            text-align: center; padding: 30px 15px;
            background: var(--primary-gradient); color: white;
            border-radius: 20px; margin-bottom: 20px;
        }
        
        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 15px; right: 15px; max-width: 470px; margin: 0 auto;
            height: 65px; border-radius: 20px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .light-theme .bottom-nav { background: #ffffff; }
        .dark-theme .bottom-nav { background: #2f3640; }
        .nav-btn {
            background: none; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem; color: #a4b0be; transition: all 0.3s; width: 20%;
        }
        .nav-btn.active { color: var(--primary-color); }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; }

        /* --- POPUPS & FORMS --- */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        .popup-content { padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 320px; animation: popUp 0.3s; position: relative; }
        .light-theme .popup-content { background: #fff; } .dark-theme .popup-content { background: #2f3640; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-top: 5px; font-family: inherit; }
        .dark-theme input { background: #3d4652; border-color: #57606f; color: white; }

        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--background-light); }
        .spinner { width: 40px; height: 40px; border-radius: 50%; border: 4px solid #ddd; border-top-color: var(--primary-color); animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Chart Styles */
        .chart { display: flex; justify-content: space-around; align-items: flex-end; height: 120px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px;}
        .bar { width: 10%; background: var(--primary-gradient); border-radius: 4px 4px 0 0; }
        .chart-labels { display: flex; justify-content: space-around; font-size: 0.65rem; margin-top: 5px; opacity: 0.7; }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="app-loader"><div class="spinner"></div></div>

    <!-- Popup -->
    <div id="popup" class="popup-overlay">
        <div class="popup-content">
            <div id="popup-body"></div>
            <button class="action-btn" style="margin-top:15px; width:100%; background: #636e72;" onclick="document.getElementById('popup').style.display='none'">Close</button>
        </div>
    </div>

    <!-- Code Input Popup (Hidden by default) -->
    <div id="code-popup" class="popup-overlay" style="z-index: 10001;">
        <div class="popup-content">
            <h3>Verification Code</h3>
            <p style="font-size:0.8rem; margin-bottom:10px;">Enter the code from the video/page:</p>
            <input type="text" id="task-code-input" placeholder="Enter Code" style="text-align:center; font-weight:bold; letter-spacing:2px; margin-bottom:15px;">
            <button id="submit-code-btn" class="action-btn" style="width:100%;">Verify</button>
            <button onclick="document.getElementById('code-popup').style.display='none'" style="background:none; border:none; color:#e74c3c; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="app" style="display: none;">
        
        <!-- Premium Header -->
        <header class="premium-header">
            <div class="user-nav-info">
                <img id="header-photo" src="https://via.placeholder.com/40" alt="User">
                <div class="header-text">
                    <span id="header-name">User</span>
                    <span class="user-rank">Member</span>
                </div>
            </div>
            <div class="balance-badge"><i class="fas fa-coins"></i> <span id="header-balance">0.00</span></div>
        </header>

        <main id="main-content">
            
            <!-- HOME PAGE -->
            <div id="home-page" class="page active">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Daily Ads</h3><p id="daily-ads-watched">0/0</p></div>
                    <div class="stat-card"><h3>Total Earned</h3><p id="total-earned">0.00</p></div>
                </div>
                <div class="stat-card" style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align:left;"><h3>Earning Wallet</h3><p style="font-size:1.5rem;" id="earning-wallet-balance">0.00</p></div>
                    <button id="move-to-balance-btn" class="action-btn" disabled><i class="fas fa-exchange-alt"></i> Move</button>
                </div>
                <div class="chart-container" style="padding:15px; background:var(--surface-light); border-radius:16px; margin-bottom:20px; box-shadow:var(--shadow);">
                    <div id="earnings-chart" class="chart"></div><div id="earnings-chart-labels" class="chart-labels"></div>
                </div>
            </div>

            <!-- TASKS PAGE -->
            <div id="tasks-page" class="page">
                <h2 class="section-title"><i class="fas fa-play-circle"></i> Daily Ads</h2>
                <div id="ad-progress-container" style="margin-bottom:15px;"></div>
                <div id="ad-task-container"></div>
                
                <!-- BONUS TASKS SECTION (Updated) -->
                <h2 class="section-title"><i class="fas fa-gift"></i> Bonus Tasks</h2>
                <div id="dynamic-tasks-container">
                    <!-- Dynamic tasks will load here via JS -->
                </div>
            </div>

            <!-- REFER PAGE -->
            <div id="refer-page" class="page">
                <div class="refer-hero">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <h2>Invite Friends</h2>
                    <p>Earn <span id="ref-bonus-val">0</span> TK per invite!</p>
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:10px; margin-top:15px; display:flex; align-items:center;">
                        <span id="referral-link" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:0.8rem; flex-grow:1;">Loading...</span>
                        <button id="copy-ref-link-btn" style="background:none; border:none; color:white;"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <h2 class="section-title">Top Referrers</h2>
                <ul id="referral-leaderboard-list" style="list-style:none; background:var(--surface-light); border-radius:16px; padding:10px;"></ul>
            </div>

            <!-- WALLET PAGE -->
            <div id="wallet-page" class="page">
                <div class="wallet-card">
                    <div style="font-size:0.9rem; opacity:0.8;">Available Balance</div>
                    <div style="font-size:2.2rem; font-weight:700; margin:5px 0 15px;"><span id="wallet-page-balance">0.00</span> TK</div>
                </div>
                <h2 class="section-title">Withdraw Funds</h2>
                <div id="withdraw-section"></div>
                <h2 class="section-title">History</h2>
                <div id="withdrawal-history-list" style="background:var(--surface-light); border-radius:16px; padding:10px; min-height:100px;"></div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="profile-page" class="page">
                <div style="text-align: center; margin: 30px 0;">
                    <img id="profile-photo-large" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary-color);">
                    <h2 id="profile-name-large">User</h2>
                    <p>ID: <span id="user-id-display"></span></p>
                </div>
            </div>

        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="tasks-page"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-btn" data-page="refer-page"><i class="fas fa-user-plus"></i><span>Refer</span></button>
            <button class="nav-btn" data-page="wallet-page"><i class="fas fa-wallet"></i><span>Wallet</span></button>
            <button class="nav-btn" data-page="profile-page"><i class="fas fa-user"></i><span>Profile</span></button>
        </nav>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        
        // --- FIREBASE CONFIG (USE YOUR OWN KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBLiCGAU2qQ1qa1IuzaerZYPlwsr93Hs_s",
            authDomain: "bigger-88989.firebaseapp.com",
            databaseURL: "https://bigger-88989-default-rtdb.firebaseio.com",
            projectId: "bigger-88989",
            storageBucket: "bigger-88989.firebasestorage.app",
            messagingSenderId: "288559349702",
            appId: "1:288559349702:web:9232a6bca6ec1ade4a3cc7"
        };
        
        let appConfig = {}; let userState = {}; let tgUser = {}; let earningWalletBalance = 0;
        let leaderboardData = { referral: [] }; let userTransactions = [];

        // UI Helpers
        const popup = document.getElementById('popup');
        const popupBody = document.getElementById('popup-body');
        const codePopup = document.getElementById('code-popup');
        
        const showPopup = (html) => { popupBody.innerHTML = html; popup.style.display = 'flex'; };
        const closePopup = () => { popup.style.display = 'none'; };

        const loadAdSdk = (zoneId) => {
            if (!zoneId || document.querySelector(`script[data-zone='${zoneId}']`)) return;
            const script = document.createElement('script');
            script.src = `//libtl.com/sdk.js`;
            script.setAttribute('data-zone', zoneId);
            script.setAttribute('data-sdk', `show_${zoneId}`);
            script.async = true;
            document.body.appendChild(script);
        };

        const initApp = async () => {
            tg.ready(); tg.expand();
            document.body.className = `${tg.colorScheme}-theme`;
            tgUser = tg.initDataUnsafe.user || { id: 'test_1', first_name: 'Test', last_name: 'User', photo_url: 'https://via.placeholder.com/40' };

            try {
                firebase.initializeApp(firebaseConfig); 
                const db = firebase.database();
                
                // Load Config
                const configSnap = await db.ref('config').once('value');
                appConfig = configSnap.val() || {};
                
                // Fallback Task Config (যদি ডাটাবেসে না থাকে, টেস্টিংয়ের জন্য)
                if(!appConfig.tasks) {
                    appConfig.tasks = {
                        "t1": { type: "telegram", name: "Join Channel", reward: 5, url: "https://t.me/telegram", chatId: "@telegram", botToken: "" },
                        "t2": { type: "video", name: "Watch Video", reward: 10, url: "https://youtube.com", timer: 60, code: "1234" },
                        "t3": { type: "visit", name: "Visit Website", reward: 2, url: "https://google.com", timer: 10 }
                    };
                }

                // Load User
                await loadUserData(db);

                // Load Extras
                loadAdSdk(appConfig.adZoneId);
                const refSnap = await db.ref('users').orderByChild('referrals').limitToLast(10).once('value');
                refSnap.forEach(c => leaderboardData.referral.push(c.val()));
                leaderboardData.referral.reverse();
                
                const histSnap = await db.ref('withdrawals/pending').orderByChild('userId').equalTo(tgUser.id).once('value');
                histSnap.forEach(c => userTransactions.push(c.val()));

                earningWalletBalance = parseFloat(localStorage.getItem(`earningWallet_${tgUser.id}`) || '0');

                renderUI(); 
                setupEventListeners();
                document.getElementById('app-loader').style.display = 'none';
                document.getElementById('app').style.display = 'block';

            } catch (e) { console.error(e); tg.showAlert("Connection Error"); }
        };

        const loadUserData = async (db) => {
            const userRef = db.ref(`users/${tgUser.id}`);
            const snap = await userRef.once('value');
            let data = snap.val();
            
            if (!data) {
                const refId = tg.initDataUnsafe.start_param;
                data = { 
                    id: tgUser.id, firstName: tgUser.first_name, lastName: tgUser.last_name || '', 
                    photoUrl: tgUser.photo_url, balance: 0, referrals: 0, totalEarned: 0, 
                    dailyAdCount: 0, completedTasks: {} 
                };
                await userRef.set(data);
                if (refId && refId != tgUser.id) {
                    db.ref(`users/${refId}`).transaction(curr => {
                        if(curr) { curr.balance = (curr.balance||0) + (appConfig.referralBonus||0); curr.referrals = (curr.referrals||0)+1; }
                        return curr;
                    });
                }
            }
            userState = data;
        };

        const renderUI = () => {
            // Header
            document.getElementById('header-photo').src = userState.photoUrl || 'https://via.placeholder.com/40';
            document.getElementById('header-name').textContent = userState.firstName;
            document.getElementById('header-balance').textContent = userState.balance.toFixed(2);
            document.getElementById('wallet-page-balance').textContent = userState.balance.toFixed(2);
            
            // Dashboard
            document.getElementById('daily-ads-watched').textContent = `${userState.dailyAdCount}/${appConfig.dailyAdLimit||0}`;
            document.getElementById('total-earned').textContent = userState.totalEarned.toFixed(2);
            document.getElementById('earning-wallet-balance').textContent = earningWalletBalance.toFixed(2);
            document.getElementById('move-to-balance-btn').disabled = earningWalletBalance < 100;
            
            // Refer
            document.getElementById('referral-link').textContent = `https://t.me/${appConfig.botUsername}/app?startapp=${tgUser.id}`;
            document.getElementById('ref-bonus-val').textContent = appConfig.referralBonus || 0;
            
            renderAdTask();
            renderDynamicTasks(); // Main new logic here
            renderLeaderboard();
            renderWithdrawalHistory();
            renderWithdrawSection();
            renderGraph();
        };

        // --- NEW: DYNAMIC TASK LOGIC (TELEGRAM, VIDEO, VISIT) ---
        const renderDynamicTasks = () => {
            const container = document.getElementById('dynamic-tasks-container');
            container.innerHTML = '';

            const tasks = [];
            for(let k in appConfig.tasks) tasks.push({id: k, ...appConfig.tasks[k]});
            
            tasks.forEach(task => {
                const isDone = userState.completedTasks && userState.completedTasks[task.id];
                
                let icon = '<i class="fas fa-star"></i>';
                let bg = 'linear-gradient(135deg, #a55eea, #8854d0)';
                let btnHtml = '';

                // --- 1. TELEGRAM TASK ---
                if (task.type === 'telegram') {
                    icon = '<i class="fab fa-telegram-plane"></i>';
                    bg = 'linear-gradient(135deg, #3498db, #2980b9)';
                    
                    if (isDone) {
                        btnHtml = `<button class="action-btn btn-done">Completed</button>`;
                    } else {
                        // Check if user clicked start previously (stored in localstorage)
                        const hasStarted = localStorage.getItem(`tg_task_${task.id}_start`);
                        if(hasStarted) {
                            btnHtml = `<button class="action-btn btn-verify" onclick="verifyTelegramTask('${task.id}')">Verify</button>`;
                        } else {
                            btnHtml = `<button class="action-btn btn-start" onclick="startTelegramTask('${task.id}', '${task.url}')">Start</button>`;
                        }
                    }
                } 
                // --- 2. VIDEO TASK ---
                else if (task.type === 'video') {
                    icon = '<i class="fas fa-play"></i>';
                    bg = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                    
                    // Check Lock
                    const lockTime = parseInt(localStorage.getItem(`video_lock_${task.id}`) || 0);
                    const now = Date.now();
                    
                    if (isDone) {
                        btnHtml = `<button class="action-btn btn-done">Completed</button>`;
                    } else if (now < lockTime) {
                        const mins = Math.ceil((lockTime - now) / 60000);
                        btnHtml = `<button class="action-btn btn-lock">Locked (${mins}m)</button>`;
                    } else {
                        const startTime = localStorage.getItem(`video_start_${task.id}`);
                        if(startTime) {
                             btnHtml = `<button class="action-btn btn-verify" onclick="verifyVideoTask('${task.id}')">Verify Code</button>`;
                        } else {
                             btnHtml = `<button class="action-btn btn-start" onclick="startVideoTask('${task.id}', '${task.url}')">Start Watch</button>`;
                        }
                    }
                } 
                // --- 3. VISIT TASK ---
                else if (task.type === 'visit') {
                    icon = '<i class="fas fa-globe"></i>';
                    bg = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                    
                    if (isDone) {
                        btnHtml = `<button class="action-btn btn-done">Completed</button>`;
                    } else {
                        const visitStart = localStorage.getItem(`visit_start_${task.id}`);
                        if (visitStart) {
                             btnHtml = `<button class="action-btn btn-verify" onclick="verifyVisitTask('${task.id}', '${task.url}', ${task.timer})">Claim Reward</button>`;
                        } else {
                             btnHtml = `<button class="action-btn btn-start" onclick="startVisitTask('${task.id}', '${task.url}')">Visit Now</button>`;
                        }
                    }
                }

                // Render Task Card
                const div = document.createElement('div');
                div.className = 'task-container';
                div.innerHTML = `
                    <div class="task-icon-box" style="background:${bg}; color:white;">${icon}</div>
                    <div class="task-info">
                        <h3>${task.name}</h3>
                        <p>Reward: ${task.reward} TK</p>
                    </div>
                    ${btnHtml}
                `;
                container.appendChild(div);
            });
        };

        // --- TELEGRAM TASK FUNCTIONS ---
        window.startTelegramTask = (tid, url) => {
            tg.openTelegramLink(url);
            localStorage.setItem(`tg_task_${tid}_start`, 'true');
            renderDynamicTasks(); // Update button to Verify
        };

        window.verifyTelegramTask = async (tid) => {
            const task = appConfig.tasks[tid];
            showPopup(`<div class="spinner"></div><p>Checking Membership...</p>`);
            
            // Note: In client-side JS, secure Bot API calls are limited. 
            // We simulate the check or fetch via a proxy if configured.
            // For this code, we will assume a basic check mechanism or simple wait-claim if API fails.
            
            try {
                // If you have a Backend/Cloud Function, fetch(YOUR_API + /checkMember?user=...&chat=...)
                // Here simulating API Delay for UI:
                await new Promise(r => setTimeout(r, 2000));
                
                // Real API Check Logic (Example):
                /* 
                const res = await fetch(`https://api.telegram.org/bot${task.botToken}/getChatMember?chat_id=${task.chatId}&user_id=${tgUser.id}`);
                const json = await res.json();
                if(json.result && ['member','administrator','creator'].includes(json.result.status)) { ... }
                */
               
                // For demo/simulated success (Since we can't expose Token in Client securely):
                // In production, REPLACE this with real fetch call.
                const isMember = true; // Assume success for demo 
                
                if(isMember) {
                    await completeTask(tid, task.reward);
                    localStorage.removeItem(`tg_task_${tid}_start`);
                } else {
                    tg.showAlert("You haven't joined the channel yet!");
                }
            } catch (e) {
                closePopup();
                tg.showAlert("Verification Failed. Try again.");
            }
        };

        // --- VIDEO TASK FUNCTIONS ---
        window.startVideoTask = (tid, url) => {
            tg.openLink(url);
            localStorage.setItem(`video_start_${tid}`, Date.now());
            renderDynamicTasks();
        };

        window.verifyVideoTask = (tid) => {
            const task = appConfig.tasks[tid];
            const startTime = parseInt(localStorage.getItem(`video_start_${tid}`));
            const now = Date.now();
            const requiredTime = (task.timer || 60) * 1000;

            if (now - startTime < requiredTime) {
                const rem = Math.ceil((requiredTime - (now - startTime)) / 1000);
                tg.showAlert(`Please watch for ${rem} more seconds.`);
                return;
            }

            // Show Code Input
            document.getElementById('code-popup').style.display = 'flex';
            document.getElementById('task-code-input').value = '';
            
            // Handle Submit
            document.getElementById('submit-code-btn').onclick = async () => {
                const code = document.getElementById('task-code-input').value;
                if(code === task.code) {
                    document.getElementById('code-popup').style.display = 'none';
                    await completeTask(tid, task.reward);
                    localStorage.removeItem(`video_start_${tid}`);
                } else {
                    document.getElementById('code-popup').style.display = 'none';
                    tg.showAlert("Wrong Code! Task locked for 10 minutes.");
                    // Lock for 10 mins
                    localStorage.setItem(`video_lock_${tid}`, Date.now() + 600000);
                    localStorage.removeItem(`video_start_${tid}`);
                    renderDynamicTasks();
                }
            };
        };

        // --- VISIT TASK FUNCTIONS ---
        window.startVisitTask = (tid, url) => {
            tg.openLink(url);
            localStorage.setItem(`visit_start_${tid}`, Date.now());
            renderDynamicTasks();
        };

        window.verifyVisitTask = async (tid, url, timerSeconds) => {
            const startTime = parseInt(localStorage.getItem(`visit_start_${tid}`));
            const now = Date.now();
            const reqTime = timerSeconds * 1000;

            if (now - startTime < reqTime) {
                tg.showAlert(`You came back too early! Stay ${timerSeconds} seconds.`);
                // Redirect back
                tg.openLink(url);
                // Reset timer (as per requirement: "again take to link")
                localStorage.setItem(`visit_start_${tid}`, Date.now());
            } else {
                await completeTask(tid, appConfig.tasks[tid].reward);
                localStorage.removeItem(`visit_start_${tid}`);
            }
        };

        const completeTask = async (tid, reward) => {
            closePopup();
            try {
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}/completedTasks/${tid}`).set(true);
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(reward));
                
                userState.balance += reward;
                if(!userState.completedTasks) userState.completedTasks = {};
                userState.completedTasks[tid] = true;
                
                tg.HapticFeedback.notificationOccurred('success');
                showPopup(`<h3>Success!</h3><p>Task Completed. +${reward} TK Added.</p>`);
                renderUI();
            } catch(e) { tg.showAlert("Error saving progress."); }
        };

        // --- OTHER CORE FUNCTIONS (AD, WITHDRAW, NAV) ---
        // (These remain standard from previous request to keep stability)

        const handleWatchAd = async () => {
            if(userState.dailyAdCount >= appConfig.dailyAdLimit) return tg.showAlert("Daily Limit Reached");
            const adFn = window['show_' + appConfig.adZoneId];
            if(!adFn) return tg.showAlert("Ad not ready");
            
            showPopup('<div class="spinner"></div>');
            try {
                await adFn();
                earningWalletBalance += (appConfig.adValue || 0);
                localStorage.setItem(`earningWallet_${tgUser.id}`, earningWalletBalance);
                
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}`).update({
                    dailyAdCount: userState.dailyAdCount + 1,
                    totalEarned: userState.totalEarned + (appConfig.adValue || 0)
                });
                
                userState.dailyAdCount++;
                userState.totalEarned += (appConfig.adValue || 0);
                
                closePopup();
                tg.HapticFeedback.notificationOccurred('success');
                renderUI();
                tg.showAlert(`+${appConfig.adValue} TK to Earning Wallet`);
            } catch(e) { closePopup(); tg.showAlert("Ad Failed"); }
        };

        const renderAdTask = () => {
            const container = document.getElementById('ad-task-container');
            const isLimit = userState.dailyAdCount >= appConfig.dailyAdLimit;
            container.innerHTML = `
                <div class="task-container">
                    <div class="task-icon-box" style="background:#f1c40f; color:white;"><i class="fas fa-play"></i></div>
                    <div class="task-info"><h3>Watch Ad</h3><p>${isLimit ? 'Limit Reached' : 'Earn ' + (appConfig.adValue||0) + ' TK'}</p></div>
                    <button class="action-btn" onclick="handleWatchAd()" ${isLimit ? 'disabled style="background:#ccc"' : ''}>${isLimit ? 'Done' : 'Watch'}</button>
                </div>
            `;
            // Progress
            const prog = (userState.dailyAdCount / (appConfig.dailyAdLimit||1)) * 100;
            document.getElementById('ad-progress-container').innerHTML = `
                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div style="width:${prog}%; height:100%; background:var(--primary-color);"></div></div>
            `;
        };

        // Graph, Withdraw, Leaderboard Logic (Compact)
        const renderGraph = async () => {
             const ch = document.getElementById('earnings-chart'); ch.innerHTML='';
             // Placeholder visual for graph
             [20, 50, 30, 80, 40, 90, 60].forEach(h => {
                 ch.innerHTML += `<div class="bar" style="height:${h}%; width:8%;"></div>`;
             });
        };

        const renderWithdrawSection = () => {
             const sel = document.getElementById('withdraw-section');
             sel.innerHTML = `<form id="w-form" onsubmit="handleWithdraw(event)">
                <select id="w-method">${(appConfig.withdrawMethods||[]).map(m=>`<option value="${m.name}">${m.name} (Min ${m.min})</option>`).join('')}</select>
                <input id="w-acc" placeholder="Account No" required>
                <input id="w-amt" placeholder="Amount" type="number" required>
                <button type="submit" class="action-btn" style="width:100%; margin-top:10px;">Withdraw</button>
             </form>`;
        };
        
        window.handleWithdraw = async (e) => {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('w-amt').value);
            if(amt > userState.balance) return tg.showAlert("Insufficient Balance");
            // Add withdrawal logic here (Firebase push)
            tg.showAlert("Request Submitted!");
        };

        const renderWithdrawalHistory = () => {
            document.getElementById('withdrawal-history-list').innerHTML = userTransactions.map(t => 
                `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span>${t.method}</span><span style="font-weight:bold;">${t.amount} TK</span>
                </div>`
            ).join('') || '<p style="text-align:center; opacity:0.6;">No History</p>';
        };

        const renderLeaderboard = () => {
            document.getElementById('referral-leaderboard-list').innerHTML = leaderboardData.referral.map((u,i) => 
                `<li style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <span>#${i+1} ${u.firstName}</span><span style="color:var(--primary-color); font-weight:bold;">${u.referrals} Refs</span>
                </li>`
            ).join('');
        };

        const setupEventListeners = () => {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
                    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
                    document.getElementById(btn.dataset.page).classList.add('active');
                    btn.classList.add('active');
                }
            });
            document.getElementById('move-to-balance-btn').onclick = async () => {
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(earningWalletBalance));
                userState.balance += earningWalletBalance;
                earningWalletBalance = 0;
                localStorage.setItem(`earningWallet_${tgUser.id}`, 0);
                renderUI();
                tg.showAlert("Moved to Balance!");
            };
            document.getElementById('copy-ref-link-btn').onclick = () => {
                navigator.clipboard.writeText(document.getElementById('referral-link').textContent);
                tg.showAlert("Copied!");
            };
        };

        initApp();
    });
    </script>
</body>
</html>
